# M5Stack Tab5 MP3プレーヤー 仕様書

## 📋 プロジェクト概要

**プロジェクト名**: MP3Player  
**作成日**: 2025年11月  
**対象デバイス**: M5Stack Tab5 (ESP32-P4)  
**開発環境**: Arduino CLI + M5Unified ライブラリ  
**目的**: SDカードに保存されたMP3ファイルを選択して再生する音楽プレーヤー

## 🎯 機能仕様

### 主要機能

1. **MP3ファイルの検出とリスト表示**
   - SDカード内のMP3ファイル（.mp3）を自動検出
   - ファイル名のリストを画面に表示
   - スクロール可能なリスト表示

2. **ファイル選択機能**
   - タッチ操作でファイルを選択
   - 選択中のファイルをハイライト表示
   - 前/次ファイルへの移動

3. **再生制御機能**
   - 再生/一時停止
   - 停止
   - 前の曲/次の曲へのスキップ
   - 音量調整（+/-）

4. **再生情報表示**
   - 現在再生中のファイル名
   - 再生時間の表示（可能であれば）
   - 音量レベル表示

5. **UI操作**
   - タッチスクリーンによる操作
   - 直感的な操作インターフェース

## 🛠️ 必要なハードウェア

- **M5Stack Tab5** (ESP32-P4)
- **SDカード** (FAT32フォーマット)
- **MP3ファイル** (SDカードに保存)

## 📚 必要なライブラリ

### 必須ライブラリ

1. **M5Unified** (v0.2.10以上)
   - M5Stack Tab5の基本機能（ディスプレイ、スピーカー、タッチ）
   - インストール: Arduino Library Manager

2. **SD** (Arduino標準ライブラリ)
   - SDカードアクセス
   - ESP32 Arduino Coreに含まれる

3. **ESP8266Audio** (earlephilhower版)
   - MP3デコード機能
   - GitHub: https://github.com/earlephilhower/ESP8266Audio
   - インストール方法:
     ```bash
     # Arduino Library Managerから検索してインストール
     # または
     git clone https://github.com/earlephilhower/ESP8266Audio.git
     ```

### 使用するESP8266Audioコンポーネント

- `AudioOutput.h` - オーディオ出力インターフェース
- `AudioFileSourceSD.h` - SDカードからのファイル読み込み
- `AudioFileSourceID3.h` - ID3タグ処理（オプション）
- `AudioGeneratorMP3.h` - MP3デコーダー

## 🎨 UI仕様

### 画面レイアウト

```
┌─────────────────────────────────┐
│  MP3 Player          [音量: 50%] │
├─────────────────────────────────┤
│  ▶ 再生中: filename.mp3         │
│  ─────────────────────────────  │
│  📁 ファイル一覧                 │
│  ┌───────────────────────────┐ │
│  │ > file01.mp3  ← 選択中     │ │
│  │   file02.mp3               │ │
│  │   file03.mp3               │ │
│  │   file04.mp3               │ │
│  │   ...                      │ │
│  └───────────────────────────┘ │
│  ─────────────────────────────  │
│  [◀◀] [⏸] [▶▶]  [🔉-] [🔊+]   │
│  前  停止 次    音量-  音量+    │
└─────────────────────────────────┘
```

### 操作エリア

1. **ファイルリストエリア**
   - タッチでファイル選択
   - スクロール可能（上下スワイプ）
   - 選択中のファイルをハイライト

2. **コントロールボタンエリア**
   - **前の曲** (◀◀): 前のファイルに移動
   - **停止** (⏸): 再生停止
   - **次の曲** (▶▶): 次のファイルに移動
   - **音量-**: 音量を下げる
   - **音量+**: 音量を上げる

3. **再生エリア**
   - 再生/一時停止ボタン（タップで切り替え）
   - 現在のファイル名表示

## 📁 ファイル構造

```
MP3Player/
├── MP3Player.ino          # メインプログラム
├── SPECIFICATION.md       # 本仕様書
└── README.md              # 使用方法・トラブルシューティング
```

## 🔧 実装のポイント

### 1. SDカード初期化

```cpp
// Tab5のSDカードピン設定
#define SD_SPI_CS_PIN   42
#define SD_SPI_SCK_PIN  43
#define SD_SPI_MOSI_PIN 44
#define SD_SPI_MISO_PIN 39

// SPI初期化
SPI.begin(SD_SPI_SCK_PIN, SD_SPI_MISO_PIN, SD_SPI_MOSI_PIN, SD_SPI_CS_PIN);
SD.begin(SD_SPI_CS_PIN, SPI, 25000000);
```

### 2. MP3ファイル検出

- SDカードのルートディレクトリを走査
- `.mp3`拡張子のファイルをリストアップ
- ファイル名を配列に保存

### 3. オーディオ出力設定

```cpp
// M5Speaker用のカスタムAudioOutputクラス
class AudioOutputM5Speaker : public AudioOutput
{
  // M5.Speakerを使用したオーディオ出力実装
  // トリプルバッファリングでスムーズな再生
};
```

### 4. タッチ操作の実装

- 画面を複数のエリアに分割
- タッチ位置に応じて操作を判定
- ファイルリストエリア: タッチ位置から選択ファイルを決定
- ボタンエリア: 各ボタンのタッチ判定

### 5. 再生制御

- `AudioGeneratorMP3`を使用してMP3デコード
- `loop()`内で`mp3.loop()`を呼び出して継続再生
- 再生状態の管理（再生中/停止中/一時停止中）

### 6. 画面更新

- ファイルリストのスクロール表示
- 選択中のファイルのハイライト
- 再生状態の表示更新
- 音量レベルの表示

## 🎵 対応フォーマット

- **MP3**: MPEG-1 Audio Layer 3
- **サンプリングレート**: 44.1kHz推奨（その他も可）
- **ビットレート**: 128kbps以上推奨
- **チャンネル**: モノラル/ステレオ対応

## 📊 パフォーマンス要件

- **起動時間**: SDカード検出後、5秒以内にファイルリスト表示
- **ファイル検出**: 最大100ファイルまで対応
- **再生遅延**: ファイル選択後、1秒以内に再生開始
- **メモリ使用量**: 可能な限り最適化（PSRAM活用）

## 🔄 動作フロー

### 起動時

1. M5Stack Tab5初期化
2. SDカード検出・初期化
3. MP3ファイル検索・リスト作成
4. ファイルリスト表示
5. 初期状態（停止）で待機

### ファイル選択時

1. ユーザーがファイルリストをタッチ
2. 選択されたファイルをハイライト
3. 選択状態を保存

### 再生時

1. ユーザーが再生ボタンをタッチ
2. 選択されたMP3ファイルを開く
3. MP3デコーダー初期化
4. 再生開始
5. 再生状態を表示に反映

### 再生中

1. `loop()`内で`mp3.loop()`を継続呼び出し
2. タッチイベントを監視
3. ボタン操作に応じて制御（停止、スキップ、音量調整）
4. 再生終了を検出

### 停止時

1. 再生を停止
2. ファイルを閉じる
3. デコーダーをリセット
4. 停止状態を表示に反映

## 🎮 操作マニュアル（予定）

### 基本操作

1. **ファイル選択**
   - ファイルリストエリアをタッチ
   - 上下にスワイプしてスクロール

2. **再生開始**
   - ファイルを選択後、再生ボタンをタッチ
   - または、ファイルリストのファイル名を直接タッチ

3. **再生制御**
   - **停止**: 停止ボタンをタッチ
   - **次の曲**: 次の曲ボタンをタッチ
   - **前の曲**: 前の曲ボタンをタッチ

4. **音量調整**
   - 音量+ボタン: 音量を上げる
   - 音量-ボタン: 音量を下げる

## ⚠️ 制約事項

1. **ファイル数制限**: メモリ制約により、最大100ファイルまで対応
2. **ファイル名**: 長いファイル名は表示を省略
3. **同時再生**: 1つのファイルのみ再生可能
4. **フォルダ構造**: 現バージョンではルートディレクトリのみ対応（将来拡張可能）

## 🚀 将来の拡張機能（オプション）

1. **フォルダ対応**: サブフォルダ内のMP3ファイルも検出
2. **プレイリスト機能**: お気に入りリストの作成・保存
3. **再生モード**: リピート、シャッフル再生
4. **ID3タグ表示**: アーティスト名、タイトル、アルバム名の表示
5. **再生時間表示**: 現在時間/総時間の表示
6. **イコライザー**: 音質調整機能
7. **Bluetooth接続**: 外部スピーカーへの接続

## 📝 開発メモ

### 実装優先順位

1. **Phase 1**: 基本機能
   - SDカード検出
   - MP3ファイル検出・リスト表示
   - 基本的な再生機能

2. **Phase 2**: UI改善
   - タッチ操作の実装
   - ファイル選択機能
   - ボタン操作

3. **Phase 3**: 高度な機能
   - 音量調整
   - 前/次曲スキップ
   - 再生状態表示の改善

4. **Phase 4**: 最適化
   - メモリ使用量の最適化
   - 再生品質の向上
   - UIのレスポンス改善

### 技術的な注意点

1. **メモリ管理**
   - 大きなMP3ファイルの処理に注意
   - バッファサイズの最適化
   - PSRAMの活用

2. **I/O処理**
   - SDカードの読み込み速度を考慮
   - バッファリング戦略の検討

3. **タッチ操作**
   - 誤タッチの防止
   - スクロール操作の実装
   - ボタンエリアの明確な分離

4. **オーディオ処理**
   - スムーズな再生のためのバッファリング
   - 再生中断時のクリーンアップ

## 📖 参考資料

- [M5Stack Tab5 公式ドキュメント](https://docs.m5stack.com/)
- [M5Unified ライブラリ](https://github.com/m5stack/M5Unified)
- [ESP8266Audio ライブラリ](https://github.com/earlephilhower/ESP8266Audio)
- [Arduino SD ライブラリ](https://www.arduino.cc/reference/en/libraries/sd/)

---

**仕様書作成日**: 2025年12月6日  
**バージョン**: 1.0  
**ステータス**: 仕様確定・実装待ち

