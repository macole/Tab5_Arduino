# UnitRFID2_ReadWrite - RFIDカード読み書き

M5Stack Tab5とUnit RFID2を使用してRFIDカードの読み書きを行うプログラムです。タッチ操作でセクター/ブロック番号を選択し、データの読み書きが可能です。

## 📋 概要

このプログラムは、M5Stack Unit RFID2を使用してMIFARE Classicカードの読み書きを行います。画面をタッチしてセクター/ブロック番号を選択し、指定したブロックのデータを読み書きできます。シリアルモニターから書き込みデータを送信することも可能です。

## 🔧 必要なハードウェア

- M5Stack Tab5
- M5Stack Unit RFID2
- RFIDカードまたはタグ（MIFARE Classic対応）

## 📚 必要なライブラリ

- **M5Unified**: M5Stack統合ライブラリ
  ```bash
  arduino-cli lib install "M5Unified@0.2.10"
  ```

- **MFRC522_I2C**: MFRC522用I2Cライブラリ
  ```bash
  arduino-cli lib install "MFRC522_I2C"
  ```

## 🚀 セットアップ

1. **ハードウェア接続**
   - Unit RFID2をM5Stack Tab5のI2Cポートに接続
   - I2Cアドレス: `0x28`

2. **ボード設定**
   - Board: ESP32P4 Dev Module
   - USB CDC on boot: Enabled
   - Flash Size: 16MB (128Mb)
   - Partition Scheme: Custom
   - PSRAM: Enabled

3. **プログラムのアップロード**
   - Arduino IDEまたはArduino CLIでプログラムをアップロード

## 💻 使用方法

### 基本操作

1. **RFIDカードの読み取り**
   - Unit RFID2の上にRFIDカードをかざす
   - 画面にUID、カードタイプ、現在のセクター/ブロック番号が表示されます

2. **タッチ操作**
   - 画面を4分割して操作エリアを定義：
     - **左上**: セクター番号+1（0〜15）
     - **右上**: ブロック番号+1（0〜2）
     - **左下**: ブロックデータ読み込み
     - **右下**: 全データ読み込み（シリアルモニターに表示）

3. **データの書き込み**
   - シリアルモニターから16文字以内のデータを送信
   - 現在選択されているセクター/ブロックにデータが書き込まれます

### 画面表示

```
RFID2  Card  Reader / Writer
Please put the card
─────────────────────────────
Touch: Sector+ | Block+ | Read | All
UID : XX XX XX XX
TYPE No. 4
TYPE Name : MIFARE 1KB
Sector : 0/Block : 0/Add : 0
Write : [書き込みデータ]
Read : [読み込みデータ]
```

## 📊 機能

- **RFIDカード読み取り**: UID、カードタイプの表示
- **ブロックデータ読み込み**: 指定したセクター/ブロックのデータを読み取り
- **全データ読み込み**: カード全体のデータをシリアルモニターに表示
- **ブロックデータ書き込み**: シリアルモニターから送信したデータを書き込み
- **タッチ操作**: 画面をタッチしてセクター/ブロック番号を選択
- **リアルタイム表示**: 読み書きしたデータを画面に表示

## 🔍 プログラムの動作

### 1. 初期化
- M5Stackの初期化
- I2C通信の初期化（`Wire.begin()`）
- MFRC522の初期化
- 初期画面の表示

### 2. カード検出
- 新しいカードが検出されるまで待機
- カードが検出されるとUIDとタイプを表示

### 3. タッチ操作処理
- 画面を4分割して操作エリアを定義
- タッチ位置に応じて操作を実行

### 4. データ読み書き
- セクター認証（デフォルトキー: 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF）
- ブロックデータの読み書き
- 結果を画面とシリアルモニターに表示

## 📝 コードの主要なポイント

### セクター/ブロック番号の管理
```cpp
int sector_num = 0;  // セクター番号（0〜15）
int block_num = 0;   // ブロック番号（0〜2）
```

### 認証キー
```cpp
MFRC522_I2C::MIFARE_Key key = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};
```
デフォルトの認証キーを使用します。カードによっては異なるキーが必要な場合があります。

### ブロックアドレスの計算
```cpp
uint8_t address = sector * 4 + block;
```
セクター番号とブロック番号からブロックアドレスを計算します。

### タッチ操作エリア
```cpp
// 画面を4分割
int area_width = screen_width / 2;
int area_height = screen_height / 2;

// 左上: セクター番号+1
// 右上: ブロック番号+1
// 左下: ブロックデータ読み込み
// 右下: 全データ読み込み
```

## ⚠️ 重要な注意事項

### 書き込み可能なブロック
- **ブロック0**: 書き込み不可（UIDが格納されている）
- **ブロック3, 7, 11, ...**: 書き込み不可（セクタートレーラーブロック）
- **その他のブロック**: 書き込み可能

### データサイズ
- 1ブロックあたり16バイト
- シリアルモニターから送信するデータは16文字以内

### カードタイプ
このプログラムは以下のカードタイプをサポートします：
- MIFARE Mini
- MIFARE 1KB
- MIFARE 4KB
- MIFARE Ultralight

## 🔧 トラブルシューティング

### 問題1: 認証に失敗する

**症状**: 「認証に失敗しました」と表示される

**解決策**:
- カードの認証キーがデフォルト（0xFF...）でない可能性があります
- カードの仕様を確認し、正しい認証キーを使用してください
- 書き込み保護がかかっている可能性があります

### 問題2: 書き込みができない

**症状**: データを書き込もうとしても失敗する

**解決策**:
- ブロック0やセクタートレーラーブロック（ブロック3, 7, 11など）には書き込めません
- 別のブロックを選択してください
- カードが書き込み保護されている可能性があります

### 問題3: タッチ操作が反応しない

**症状**: 画面をタッチしても操作が実行されない

**解決策**:
- カードが検出されていることを確認してください
- タッチ位置が正しいエリアにあるか確認してください
- 画面の4分割エリアを確認してください

### 問題4: シリアルモニターにデータが表示されない

**解決策**:
- ボーレートが115200に設定されているか確認
- シリアルモニターが正しいポートに接続されているか確認
- 「右下」エリアをタッチして全データ読み込みを実行してください

## 📖 MIFARE Classicの構造

### セクター構造
- 1セクター = 4ブロック（16バイト × 4 = 64バイト）
- ブロック0〜2: データブロック
- ブロック3: セクタートレーラーブロック（認証キー、アクセス条件）

### セクター数
- **MIFARE Mini**: 5セクター
- **MIFARE 1KB**: 16セクター
- **MIFARE 4KB**: 40セクター

## 💡 使用例

### データの読み込み
1. RFIDカードをかざす
2. セクター/ブロック番号を選択（左上/右上をタッチ）
3. 左下をタッチしてデータを読み込み
4. 画面とシリアルモニターにデータが表示されます

### データの書き込み
1. RFIDカードをかざす
2. セクター/ブロック番号を選択
3. シリアルモニターから16文字以内のデータを送信
4. データがカードに書き込まれます

### 全データの確認
1. RFIDカードをかざす
2. 右下をタッチ
3. シリアルモニターにカード全体のデータが表示されます

## 🔗 関連ファイル

- `UnitRFID2.ino`: 読み取り専用版（PICCタイプ表示）
- `UnitRFID2_UID.ino`: UID表示のみのシンプル版

## 📖 参考資料

- [M5Stack Unit RFID2 公式ドキュメント](https://docs.m5stack.com/)
- [MFRC522 データシート](https://www.nxp.com/docs/en/data-sheet/MFRC522.pdf)
- [MIFARE Classic 仕様](https://www.nxp.com/docs/en/data-sheet/MF1S50YYX_V1.pdf)
- [M5Unified ライブラリ](https://github.com/m5stack/M5Unified)

## 📄 ライセンス

このプログラムはMITライセンスの下で公開されています。

Copyright (c) 2025 macole

詳細はプロジェクトルートの`LICENSE`ファイルを参照してください。

---

**作成日**: 2025年11月  
**対象デバイス**: M5Stack Tab5 + Unit RFID2  
**動作確認**: ✅ 正常動作確認済み

