# Phomemo T02 Bluetooth プリンター 仕様書

## 📋 プロジェクト概要

**プロジェクト名**: PhomemoT02_Bluetooth  
**作成日**: 2025年11月  
**対象デバイス**: M5Stack Tab5 (ESP32-P4)  
**対象プリンター**: Phomemo T02 ポータブルプリンター  
**開発環境**: Arduino CLI + M5Unified ライブラリ  
**目的**: M5Stack Tab5からPhomemo T02にBluetooth接続してテキストや画像を印刷する

## 🎯 機能仕様

### 主要機能

1. **Bluetooth接続機能**
   - Phomemo T02の検出とペアリング
   - Bluetooth接続の確立と維持
   - 接続状態の表示

2. **テキスト印刷機能**
   - プレーンテキストの印刷
   - 日本語テキストの印刷（文字コード変換対応）
   - フォントサイズの変更（小/中/大）
   - テキストの配置（左/中央/右）
   - 改行制御

3. **画像印刷機能**｀
   - ビットマップ画像の印刷
   - 画像のリサイズと変換
   - グレースケール変換

4. **印刷制御機能**
   - 用紙カット（自動/手動）
   - 印刷密度の調整
   - 印刷速度の調整
   - 印刷前のプレビュー表示

5. **UI操作機能**
   - タッチスクリーンによる操作
   - 接続状態の表示
   - 印刷履歴の表示
   - エラーメッセージの表示

## 🛠️ 必要なハードウェア

- **M5Stack Tab5** (ESP32-P4)
- **Phomemo T02** ポータブルプリンター
- **サーマル用紙** (58mm幅)

## 📚 必要なライブラリ

### 必須ライブラリ

1. **M5Unified** (v0.2.10以上)
   - M5Stack Tab5の基本機能（ディスプレイ、タッチ）
   - インストール: Arduino Library Manager

2. **BluetoothSerial** (ESP32 Arduino Coreに含まれる)
   - Bluetooth Classic (SPP) 通信
   - ESP32-P4で標準サポート

3. **ESP32 BLE** (オプション、将来の拡張用)
   - BLE接続対応（Phomemo T02がBLE対応の場合）

### 追加ライブラリ（必要に応じて）

- **画像処理ライブラリ**: 画像のリサイズ・変換用
- **文字コード変換ライブラリ**: 日本語文字のエンコーディング変換用

## 🔌 Phomemo T02 仕様（推定）

### 基本仕様

- **接続方式**: Bluetooth Classic (SPP)
- **用紙幅**: 58mm
- **印刷解像度**: 203 DPI (8 dots/mm)
- **印刷幅**: 384 dots (48mm)
- **用紙タイプ**: サーマル用紙
- **プロトコル**: ESC/POS互換（推定）

### ESC/POSコマンド（一般的なサーマルプリンター）

Phomemo T02は一般的なESC/POSコマンドセットを使用している可能性が高いです：

- **初期化**: `ESC @` (0x1B 0x40)
- **改行**: `LF` (0x0A)
- **用紙カット**: `GS V m` (0x1D 0x56 m)
- **太字**: `ESC E n` (0x1B 0x45 n)
- **フォントサイズ**: `GS ! n` (0x1D 0x21 n)
- **中央揃え**: `ESC a 1` (0x1B 0x61 1)
- **画像印刷**: `GS v 0` (0x1D 0x76 0)

**注意**: Phomemo T02の実際のプロトコルは公式に公開されていないため、実装時にプロトコル解析が必要になる可能性があります。

## 🎨 UI仕様

### 画面レイアウト

```
┌─────────────────────────────────┐
│  Phomemo T02 Printer            │
│  Status: [Connected/Disconnected]│
├─────────────────────────────────┤
│  Connection:                     │
│  [Scan] [Connect] [Disconnect]  │
│  ─────────────────────────────   │
│  Print Options:                   │
│  Font: [Small] [Medium] [Large]  │
│  Align: [Left] [Center] [Right]  │
│  ─────────────────────────────   │
│  Text Input:                      │
│  ┌───────────────────────────┐  │
│  │ [Text input area]          │  │
│  └───────────────────────────┘  │
│  ─────────────────────────────   │
│  [Print Text] [Print Image]      │
│  [Cut Paper] [Settings]           │
└─────────────────────────────────┘
```

### 操作エリア

1. **接続エリア**
   - **Scan**: 周辺のBluetoothデバイスをスキャン
   - **Connect**: Phomemo T02に接続
   - **Disconnect**: 接続を切断
   - 接続状態の表示

2. **印刷オプションエリア**
   - **Font Size**: フォントサイズ選択（小/中/大）
   - **Alignment**: テキスト配置（左/中央/右）

3. **テキスト入力エリア**
   - タッチキーボードまたはテキスト入力フィールド
   - 入力テキストの表示

4. **操作ボタンエリア**
   - **Print Text**: テキストを印刷
   - **Print Image**: 画像を印刷（将来の拡張）
   - **Cut Paper**: 用紙をカット
   - **Settings**: 設定画面

## 📁 ファイル構造

```
PhomemoT02_Bluetooth/
├── PhomemoT02_Bluetooth.ino    # メインプログラム
├── SPECIFICATION.md             # 本仕様書
├── README.md                   # 使用方法・トラブルシューティング
└── escpos.h                     # ESC/POSコマンド定義（オプション）
```

## 🔧 実装のポイント

### 1. Bluetooth接続

```cpp
#include "BluetoothSerial.h"

BluetoothSerial SerialBT;

void setup() {
  SerialBT.begin("M5Stack_Tab5"); // デバイス名
  // Phomemo T02のMACアドレスまたはデバイス名で接続
}
```

### 2. デバイス検出

- BluetoothスキャンでPhomemo T02を検出
- デバイス名またはMACアドレスで識別
- 接続可能なデバイスのリスト表示

### 3. ESC/POSコマンド送信

```cpp
// 初期化コマンド
void initPrinter() {
  SerialBT.write(0x1B);  // ESC
  SerialBT.write(0x40);  // @
}

// テキスト印刷
void printText(String text) {
  SerialBT.print(text);
  SerialBT.write(0x0A);  // LF (改行)
}

// 用紙カット
void cutPaper() {
  SerialBT.write(0x1D);  // GS
  SerialBT.write(0x56);  // V
  SerialBT.write(0x00);  // 完全カット
}
```

### 4. 文字コード変換

- UTF-8からShift-JISへの変換（日本語対応）
- または、Phomemo T02が対応する文字コードを確認

### 5. 画像印刷

- 画像を1ビットビットマップに変換
- ESC/POS画像コマンドで送信
- リサイズ処理（384ドット幅に合わせる）

### 6. エラーハンドリング

- 接続エラーの検出と表示
- 印刷エラーの検出と表示
- タイムアウト処理

## 📊 プロトコル仕様（推定）

### 接続手順

1. BluetoothスキャンでPhomemo T02を検出
2. デバイス名またはMACアドレスで接続
3. SPP (Serial Port Profile) でシリアル通信確立

### データ送信形式

- **通信方式**: バイナリデータ
- **エンディアン**: リトルエンディアン（一般的）
- **文字コード**: Shift-JISまたはUTF-8（要確認）

### ESC/POSコマンド例

```
初期化:        1B 40
改行:          0A
用紙カット:    1D 56 00
太字ON:        1B 45 01
太字OFF:       1B 45 00
フォント2倍:    1D 21 11
中央揃え:      1B 61 01
左揃え:        1B 61 00
```

## ⚠️ 制約事項と注意点

1. **プロトコル未公開**
   - Phomemo T02の公式プロトコル仕様が公開されていない
   - 一般的なESC/POSコマンドを試行する必要がある
   - 実機での動作確認が必須

2. **文字コード対応**
   - 日本語文字のエンコーディング変換が必要な可能性
   - Phomemo T02が対応する文字コードを確認

3. **画像形式**
   - サーマルプリンターは1ビットビットマップのみ対応
   - カラー画像はグレースケール変換が必要

4. **接続安定性**
   - Bluetooth接続の維持と再接続処理
   - タイムアウト処理の実装

5. **用紙管理**
   - 用紙切れの検出（可能であれば）
   - 用紙カットのタイミング制御

## 🚀 実装フェーズ

### Phase 1: 基本接続
- Bluetooth接続の確立
- デバイス検出機能
- 接続状態の表示

### Phase 2: テキスト印刷
- 基本的なテキスト印刷
- ESC/POSコマンドの実装
- フォントサイズ・配置の制御

### Phase 3: 日本語対応
- 文字コード変換
- 日本語テキストの印刷
- 特殊文字の処理

### Phase 4: 画像印刷
- 画像の読み込みと変換
- ビットマップ変換
- 画像印刷機能

### Phase 5: UI改善
- タッチ操作の最適化
- 設定画面の実装
- エラーハンドリングの強化

## 🔍 デバッグとテスト

### テスト項目

1. **接続テスト**
   - デバイス検出の確認
   - 接続確立の確認
   - 切断・再接続の確認

2. **印刷テスト**
   - プレーンテキストの印刷
   - 日本語テキストの印刷
   - 特殊文字の印刷
   - フォントサイズ変更の確認
   - 配置変更の確認

3. **エラーハンドリングテスト**
   - 接続エラーの処理
   - 印刷エラーの処理
   - タイムアウト処理

### デバッグ方法

- シリアルモニターでBluetooth通信を監視
- 送信データの16進数ダンプ
- 受信データの確認（可能であれば）

## 📖 参考資料

- [ESP32 BluetoothSerial Documentation](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/bluetooth/bt_spp.html)
- [ESC/POS Command Reference](https://reference.epson-biz.com/modules/ref_escpos/)
- [Phomemo T02 公式サイト](https://phomemo.com/)
- [M5Stack Tab5 公式ドキュメント](https://docs.m5stack.com/)

## 🔄 代替案

Phomemo T02のプロトコルが不明な場合の代替案：

1. **プロトコル解析**
   - Phomemo公式アプリの通信を解析
   - Bluetoothパケットキャプチャツールを使用

2. **一般的なESC/POSコマンドの試行**
   - 標準的なESC/POSコマンドを試行
   - 動作するコマンドを特定

3. **Phomemo公式サポートへの問い合わせ**
   - 開発者向けAPIやSDKの有無を確認

## 📝 開発メモ

### 実装優先順位

1. **最優先**: Bluetooth接続の確立
2. **高優先度**: 基本的なテキスト印刷
3. **中優先度**: 日本語対応、フォント制御
4. **低優先度**: 画像印刷、高度な機能

### 技術的な注意点

1. **Bluetooth接続**
   - ESP32-P4のBluetooth Classic対応確認
   - 接続タイムアウトの設定
   - 再接続ロジックの実装

2. **データ送信**
   - バッファリングの実装
   - 送信速度の最適化
   - エラー検出とリトライ

3. **メモリ管理**
   - 大きな画像データの処理
   - メモリ使用量の最適化

4. **UI応答性**
   - 印刷中のUI更新
   - 非同期処理の実装

---

**仕様書作成日**: 2025年11月  
**バージョン**: 1.0  
**ステータス**: 仕様確定・実装待ち  
**注意**: Phomemo T02のプロトコル仕様が未公開のため、実装時にプロトコル解析が必要になる可能性があります。

